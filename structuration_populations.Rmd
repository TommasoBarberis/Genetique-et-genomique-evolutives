---
title: "Structuration des populations"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# TP de Génétique des Populations Structuration des Populations

## 1. Analyse de la structuration par la méthode de Cockerham

```{r}
data1 <- read.table("./data/TP_structuration/data1.txt", header = TRUE)
data2 <- read.table("./data/TP_structuration/data2.txt", header = TRUE)
data3 <- read.table("./data/TP_structuration/data3.txt", header = TRUE) 
```

```{r}
tail(data1)
```

-   **indiv**: individu

-   **pop**: population

-   **allele**: genotype

Chaque individu aura deux lignes, un par site.

```{r}
xtabs(~as.factor(indiv)+as.factor(pop),data=data1)
```

Donnees d'un plan experimental hierarchique car le facteur *individu* est emboité dans le facteur *population*.\
On fera une anova hierarchique de la variable *allele* en sachant que les autres deux variables (*indiv* et *pop*) sont emboitées.

```{r}
model1= <- anova(lm(allele~as.factor(pop)/as.factor(indiv), 
                    data=data1))
model1
```

1.  Estimer les $\sigma^2$

2.  Estimer les $F$

    1.  $f_{it}$: combine le $f_{st}$ et le $f_{is}$ selon la relation suivante:\$1-f\_{it} = (1- f\_{st})(1 - f\_{is})\$

    2.  $f_{st}$: la composante de la variance au niveau de la population (renseigne sur la structuration genomique de la population), autrement dit il reinseigne sur les flux de genes entre populations;

        -   0, flux de genes important entre population et donc peu de structuration;

        -   plus est grande, plus les populations sont differentes (en termes de frequence allelique) et donc le flux des genes est faible;

    3.  $f_{is}$:

        -   si valeur nulle, la panmixie est réalisé (appariement des gametes aux hasard)

Pour faire cela on a besoin des carrés moyens de l'**anova** (colonne `Mean Sq`, qui est une estimation de $E(CM)$).

```{r}
# pour accèder aux valeurs du tableau model1
model1[1,3]
```

```{r}
# x: model anova
# f: indice f
calc.f <- function (x, f) {
  n <- x[3,1]/(x[1, 1]+1) # nb indiv
  sigma_a2 <- (x[1, 3] - x[2, 3])/(2*n) 
  sigma_b2 <- (x[2, 3] - x[3, 3])/2
  sigma_w2 <- x[3, 3]
  if (f == "f_it") {
    return ((sigma_a2 + sigma_b2)/(sigma_a2 + sigma_b2 + sigma_w2))
  }
  else if (f == "f_st") {
    return (sigma_a2/(sigma_a2 + sigma_b2 + sigma_w2))
  }
  else if (f == "f_is") {
   return (sigma_b2/(sigma_b2 + sigma_w2)) 
  }
}
```

```{r}
f_it <- calc.f(model1, "f_it")
f_it # pas de correlation entre
f_st <- calc.f(model1, "f_st")
f_st
f_is <- calc.f(model1, "f_is")
f_is
```

```{r}
model2 <- anova(lm(allele~as.factor(pop)/as.factor(indiv), 
                    data=data2))
f_it <- calc.f(model2, "f_it")
f_it
f_st <- calc.f(model2, "f_st")
f_st
f_is <- calc.f(model2, "f_is")
f_is
```

f_is pres de zero, donc panmixie\
f_st assez grand $\Rightarrow$ isolement par la distance

```{r}
model3 <- anova(lm(allele~as.factor(pop)/as.factor(indiv), 
                    data=data3))
f_it <- calc.f(model3, "f_it")
f_it
f_st <- calc.f(model3, "f_st")
f_st
f_is <- calc.f(model3, "f_is")
f_is
```

f_is tres grand, niveau de consaguinite tres elevé\
f_st tres faible, donc beaucoup de flux de genes entre populations

## 2. Analyse du jeu de données du CEPH

```{r}
world <- read.table("ftp://pbil.univ-lyon1.fr/pub/cours/fablet/GGE/TP_AMOVA/diversitydata.stru", h=F, skip=1)
world.locus <- read.table("ftp://pbil.univ-lyon1.fr/pub/cours/fablet/GGE/TP_AMOVA/diversitydata.stru", h=F, nrows=1)
dim(world)
names(world)[6:382] = as.character(t(world.locus))
names(world)[1:5] = c("individu", "popcode", "Population", "Geography",
"Region")
world[world==-9] <- "NA"
world[1:5,1:8]=
world=world[,1:25]
```

```{r}
# le niveau individu est emboité dans Population
# emboité da Geography
summary(as.factor(world$Population)) # faut diviser par deux car il y a deux lignes par individu
```

```{r}
# emboité dans Region
summary(as.factor(world$Geography))
```

```{r}
summary(as.factor(world$Region))
```

```{r}
IdPops = unique(world[,3:5])
IdPops = IdPops[order(IdPops$Population),]
IdPops 
```

```{r}
par(mfrow=c(1,2))
barplot(table(world[,6]))
barplot(table(world[,7]))
```

On constante beaucoup d'alleles differents, donc un taux de mutation $\mu$ elevé.

Pour un gene à deux alleles:

-   $p^2$ $2pq$ $q^2$

-   $Hs=2pq=1-(p^2+q^2)$

```{r}
p=table(world[,6])/sum(table(world[,6]))
1 - sum(p^2)
Hs = apply(world[6:25], 2, FUN = function(x) {
	p=table(x)/sum(table(x))
	return(1-sum(p^2))
	})
hist(Hs) # sur l'ensemble des loci
```

Niveau d'heterozygotie theorique (utilisé comme estimé de la diversité génétique) assz elevé.

### Importation des données dans le package adegenet

```{r}
library(adegenet)
```

```{r}
worldadegenet <- import2genind("ftp://pbil.univ-lyon1.fr/pub/cours/fablet/GGE/TP_AMOVA/diversitydata.stru", n.ind=1056, n.loc=377, col.pop=3, col.other=c(4,5), ask=FALSE, NA.char="-9")
worldadegenet
# hist(worldadegenet$loc.n.all)
worldadegenet=worldadegenet[,1:sum(table(worldadegenet$loc.fac)[1:20])]
summary(worldadegenet)
```

-   nombre d'individus

-   nb d'individus par populations

-   nb d'allele par locus

-   nb d'allele par groupe

-   pourcentage des données manquantes

-   heterozygotie observée

-   heterozygotie theorique

### Analyse de la structure: estimation des Fstats

```{r}
library(hierfstat)
```

```{r}
worldhier=genind2hierfstat(worldadegenet)

varcomp.glob(levels=worldhier[,1],worldhier[,2:21])
# $overall
#   Pop: sigma_a2
#   Ind: sigma_b2
#   Error: sigma_w2
```

Entre `Pop` et `Total` on a le $f_{st}$, entre `Ind` et `Total` on a le $f_{it}$ et entre `Ind` et `Pop` on a le $f_{is}$.

-   $f_{is} \sim 0$ donc panmixie;

-   $f_{st}$ pas assez de puissance statistique pour voir si c'est different de zero ou pas.

```{r}
testFst <- test.g(data=worldhier[,2:21], level=worldhier[,1])
hist(testFst$g.star[1:99]) # distribution de la statistique sur 99 permutations
testFst$g.star[100] # valeur observée sur les données
```

La valeur observée sur les données est loin de la distribution nulle attendue, donc l'hypothese nulle est rejetée donc $f_{st}$ est signficativement different de zero (donc structuration entre les populations humaines significative).

### Analyse de la structure: isolement par la distance

```{r}
distancesGeo = read.table("ftp://pbil.univ-lyon1.fr/pub/cours/fablet/GGE/TP_AMOVA/distancesGeo.txt", dec=",", h=T)
distGeo = as.dist(distancesGeo)
popsworld = genind2genpop(worldadegenet)
popsworld 
distGenet=dist.genpop(popsworld, method=3) # estimation des f_st par paire de populations
plot(distGeo,distGenet)
abline(lm(distGenet~distGeo))
cor(distGenet,distGeo)^2
```

Correlation positive assez claire entre distance geographique (en $km$ entre les deux populations) et distance genetique (exprimée en $f_{st}$).

```{r}
library(ade4)
```

```{r}
ibd = mantel.randtest(distGenet, distGeo, nrepet=1000)
ibd
plot(ibd)
```

La valeurs observée est en dehors de la distribution nulle, donc on peut rejeter l'hypothese nulle est affirmer qu'il y a bien correlation entre distance geographique et genetique (le $f_{st}$ est significative en partie grace à l'isolement par la distance).

```{r}
cor(distGenet, distGeo)^2
```

### Diversité génétique par population

```{r}
parpop = seppop(worldadegenet)
names(parpop)
Htheo = lapply(parpop, FUN=function(x){ 
	s=summary(x) 
	return(s$Hexp) 
	}) 
Htheo = apply(as.data.frame(Htheo), 2, mean) 
Htheo = cbind(names(parpop), as.numeric(Htheo)) 
Htheo = Htheo[order(Htheo[,1]),] 
Htheo[1:4,]
```

### Rélation ave la distance à l'Afrique de l'Est

```{r}
distancesAfr=read.table("ftp://pbil.univ-lyon1.fr/pub/cours/fablet/GGE/TP_AMOVA/distancesAfr.txt", h=T, dec=",") 
plot(distancesAfr$DistAA, Htheo[,2], xlim=c(0,30000), ylim=c(0.2, 0.9), type="n") 
regions=as.factor(IdPops$Region)
levels(regions) = 1:7
points(distancesAfr$DistAA, Htheo[,2], col=regions) #Htheo: heterozygotie theorique
abline(lm(as.numeric(Htheo[,2])~distancesAfr$DistAA)) 
legend(0, 0.50, levels(as.factor(IdPops$Region)), col=levels(regions), pch=1)
cor(as.numeric(Htheo[,2]), distancesAfr$DistAA)
```

A partir de l'Afrique, un petit groupe d'indivdu qui a migré, et a partir de cela un nouveau groupe d'individu a migré $\Rightarrow$ **Effet fondateur en serie**. D'allieurs, il explique 80% de la variabilité.
